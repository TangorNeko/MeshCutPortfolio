# **一刀両断**
### 河原電子ビジネス専門学校
### ゲームクリエイター科2年　錦織隼王

# **目次**
### 1. [作品概要](#overview)
### 2. [操作説明](#operation)
### 3. [担当ソースコード](#responsible)
### 4. [改造したエンジンのコード](#enginecode)
### 5. [メッシュの切断](#meshcut)
### 5. [こだわった部分](#commitment)

<a id="overview"></a>

# **1. 作品概要**
* ## 一刀両断
    *ゲーム説明*  
    <!--
    動画挿入
    <iframe width="640" height="365" src="https://www.youtube.com/embed/kX87_XVBVlo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>  
    -->

    **紹介動画**
* ## 使用ゲームエンジン
    学校内製エンジンを改造して使用
* ## 使用ツール
    Visual Studio 2019  
    Visual Studio Code  
    3ds Max 2021  
    Adobe Photoshop Elements 2020  
    Git
* ## 使用言語
    C++  
    HLSL
* ## 使用ライブラリ
    BulletPhysics  
    EffekSeer  
    DirectXTK12
* ## 開発環境
    Windows10  
    DirectX12
* ## 制作人数
    1人
* ## 開発期間
    2021年9月～

<a id="operation"></a>

# **2. 操作説明**
*操作説明*  
<!--
<img src="Pictures/Control1.png" width="720">   
-->
<a id="responsible"></a>

# **3. 担当ソースコード**  

<details open>
<summary>担当ソースコード</summary>

* hoge.cpp

</details>

<a id="enginecode"></a>

# **4. 改造したエンジンのコード**
<details open>
<summary>改造したエンジンのコード</summary>

* hoge.cpp  
hoge  


</details>

<a id="meshcut"></a>

# **5. メッシュ切断** 

# シーケンス図による全体の流れ  
<img src="Pictures/SequenceDiagram.png" width="800">   

# 各手順の詳細  

## 手順1.切断準備_切断面の座標系の変換  
必要入力  
切断面上の一点  
切断面の法線ベクトル  

まず、モデルの情報はモデル内部にローカル座標系で保存されており、モデルを表示する際にワールド行列を乗算してワールド座標に変換されているため、  
切断面の座標をワールド座標のままモデルに渡してしまうと、  
正常に切断の判定ができない。  

<img src="Pictures/CoordinateTransformation.png" width="800">  

正常に切断の判定をするには、切断するモデルのローカル座標上に切断面を移す必要がある。  
そのため、モデルのワールド行列の逆行列を乗算する。  
切断面の向きにそのまま乗算すると結果がおかしくなるため、  
切断面の一点、切断面の一点から切断面の向きへのベクトルを足した一点
のそれぞれにワールド行列の逆行列を乗算し、ローカル座標での切断面の向きを計算する。  
  
<img src="Pictures/CoordinateTransformation2.png" width="800">  

## 手順2.切断単位の説明  

エンジンにある、モデルを構成する頂点バッファ、インデックスバッファ、マテリアルを保持する  
TkmFileクラス内で、MeshDividerクラスを使用することによって分割を行う。  
モデルを構成する要素のうち、メッシュパーツごとに切断を行う。  
メッシュパーツを構成するメッシュのうち、マテリアルごとに切断を行う。  
メッシュを構成するポリゴンごとに切断を行う。

*説明画像*  
  
## 手順3.ポリゴンごとの分割準備  
マテリアルごとに用意されたインデックスバッファの配列を順番に見ていく。  
0番目のインデックスバッファを走査  
今回モデルのポリゴンは3頂点で構成されているため、インデックスバッファの中を3要素ずつ見ていく。  

*説明画像*  
  
## 手順4.ポリゴンの分割  
TriangleDividerクラスで行われる。
ポリゴンの3点が、切断面の裏・表・切断面上のどこに位置するかを調べる。  
  
切断面の一点から、各点へのベクトルを求める。  
それぞれのベクトルと、切断面の法線の向きの内積を計算する。  
内積の結果が0より大きい-切断面の表側に点がある。  
内積の結果が0より小さい-切断面の裏側に点がある。  
内積の結果が0-切断面上に点がある。  
  
この計算に従い、3点をグループ分けする。
グループ分けの結果によって、ポリゴンがどう分割されているかを判定する。

考えられるパターン  
表側に頂点があり、裏側に頂点がない　非分割  
裏側に頂点があり、表側に頂点がない　非分割  
表側に頂点が2つ、裏側に頂点が1つ　分割  
裏側に頂点が2つ、表側に頂点が1つ　分割  
表側、裏側、面上にそれぞれ頂点が1つ　分割  
面上に頂点が3つある　特殊  
(※どちら側にも3頂点があるとして扱う)  

*説明画像*  
  
ポリゴンが分割されている場合、3点を結んだ線分と切断面の交差地点を  
求める。  
  
*説明画像*  
  
パターンに合わせて適切に表側、裏側のインデックスバッファに新しくできた頂点を挿入するTriangleMakerクラスの関数を呼び出す。  
TriangleMakerクラスは、パターンの見落としや、新しいパターンが増えた時のために、  
抽象クラスであるITriangleMakerを継承して作成している。  






